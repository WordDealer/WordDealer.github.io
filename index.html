<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <title>雷霆战机 - PC+手机适配版</title>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      background: black;
    }
    canvas {
      display: block;
      margin: 0 auto;
      background: url("background.png") repeat-y;
      background-size: cover;
    }
    /* 摇杆样式 */
    #joystick {
      position: fixed;
      bottom: 80px;
      left: 80px;
      width: 120px;
      height: 120px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 50%;
      border: 2px solid rgba(255,255,255,0.3);
      display: none; /* 默认隐藏，只在手机显示 */
      touch-action: none;
    }
    #stick {
      position: absolute;
      left: 50%;
      top: 50%;
      width: 60px;
      height: 60px;
      margin-left: -30px;
      margin-top: -30px;
      background: rgba(255,255,255,0.5);
      border-radius: 50%;
      touch-action: none;
    }
  </style>
</head>
<body>
  <canvas id="gameCanvas" width="480" height="640"></canvas>
  <div id="joystick"><div id="stick"></div></div>

  <script>
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");

    // 玩家飞机
    const player = {
      x: canvas.width / 2 - 20,
      y: canvas.height - 80,
      width: 40,
      height: 40,
      speed: 5
    };

    // 子弹与敌机
    const bullets = [];
    const enemies = [];

    // 控制状态
    let keys = {};
    let isMobile = /Mobi|Android|iPhone/i.test(navigator.userAgent);

    // 摇杆
    const joystick = document.getElementById("joystick");
    const stick = document.getElementById("stick");
    let joyActive = false, joyX = 0, joyY = 0;

    if (isMobile) {
      joystick.style.display = "block"; // 显示摇杆
      setInterval(() => { bullets.push({x: player.x + player.width/2 - 2, y: player.y, width:4, height:10, speed:7}); }, 300); // 自动射击
    }

    // 键盘事件 (PC)
    window.addEventListener("keydown", e => { keys[e.key] = true; });
    window.addEventListener("keyup", e => { keys[e.key] = false; });

    // 摇杆事件 (手机)
    stick.addEventListener("touchstart", e => { joyActive = true; e.preventDefault(); });
    stick.addEventListener("touchend", e => { joyActive = false; joyX = joyY = 0; stick.style.left="50%"; stick.style.top="50%"; });
    stick.addEventListener("touchmove", e => {
      e.preventDefault();
      const rect = joystick.getBoundingClientRect();
      const touch = e.touches[0];
      const dx = touch.clientX - (rect.left + rect.width/2);
      const dy = touch.clientY - (rect.top + rect.height/2);
      const dist = Math.min(Math.sqrt(dx*dx+dy*dy), rect.width/2 - 30);
      const angle = Math.atan2(dy, dx);
      joyX = Math.cos(angle) * (dist/(rect.width/2));
      joyY = Math.sin(angle) * (dist/(rect.width/2));
      stick.style.left = 50 + joyX*50 + "%";
      stick.style.top = 50 + joyY*50 + "%";
    });

    // 生成敌机
    function spawnEnemy() {
      enemies.push({x: Math.random() * (canvas.width-40), y: -40, width:40, height:40, speed:2});
    }
    setInterval(spawnEnemy, 1000);

    // 绘制矩形
    function drawRect(obj, color) {
      ctx.fillStyle = color;
      ctx.fillRect(obj.x, obj.y, obj.width, obj.height);
    }

    // 更新
    function update() {
      if (!isMobile) {
        if (keys["ArrowLeft"] && player.x > 0) player.x -= player.speed;
        if (keys["ArrowRight"] && player.x < canvas.width - player.width) player.x += player.speed;
        if (keys["ArrowUp"] && player.y > 0) player.y -= player.speed;
        if (keys["ArrowDown"] && player.y < canvas.height - player.height) player.y += player.speed;
        if (keys[" "] ) bullets.push({x: player.x+player.width/2-2,y:player.y,width:4,height:10,speed:7});
      } else {
        player.x += joyX * player.speed * 2;
        player.y += joyY * player.speed * 2;
        player.x = Math.max(0, Math.min(canvas.width-player.width, player.x));
        player.y = Math.max(0, Math.min(canvas.height-player.height, player.y));
      }

      // 更新子弹
      for (let i=bullets.length-1;i>=0;i--){
        bullets[i].y -= bullets[i].speed;
        if (bullets[i].y < 0) bullets.splice(i,1);
      }

      // 更新敌机
      for (let i=enemies.length-1;i>=0;i--){
        enemies[i].y += enemies[i].speed;
        if (enemies[i].y > canvas.height) enemies.splice(i,1);
      }
    }

    // 碰撞检测
    function isCollide(a,b) {
      return a.x < b.x+b.width && a.x+a.width>b.x && a.y<a.y+b.height && a.y+a.height>b.y;
    }

    // 绘制
    function draw() {
      ctx.clearRect(0,0,canvas.width,canvas.height);
      drawRect(player,"cyan");
      bullets.forEach(b=>drawRect(b,"yellow"));
      enemies.forEach(e=>drawRect(e,"red"));
    }

    // 游戏循环
    function loop() {
      update();
      draw();
      requestAnimationFrame(loop);
    }
    loop();
  </script>
</body>
</html>
