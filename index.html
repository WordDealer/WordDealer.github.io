<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <title>雷霆战机(高木版) - HTML5 版</title>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      background: black;
      text-align: center;
    }
    canvas {
      display: block;
      margin: 0 auto;
      background: url("background.png") repeat-y;
      background-size: cover;
    }
    #score {
      position: absolute;
      top: 10px;
      left: 10px;
      color: white;
      font-size: 20px;
      font-family: Arial, sans-serif;
    }
    #startBtn {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      padding: 15px 30px;
      font-size: 24px;
      cursor: pointer;
    }
    /* 遥感样式 */
    #joystickContainer {
      position: absolute;
      bottom: 80px;
      left: 80px;
      width: 120px;
      height: 120px;
      display: none;
      touch-action: none;
    }
    #joystickBase {
      position: absolute;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 50%;
    }
    #joystickThumb {
      position: absolute;
      width: 60px;
      height: 60px;
      background: rgba(255, 255, 255, 0.5);
      border-radius: 50%;
      left: 30px;
      top: 30px;
      touch-action: none;
    }
  </style>
</head>
<body>
  <div id="score">捉弄次数: 0</div>
  <canvas id="gameCanvas" width="480" height="640"></canvas>

  <button id="startBtn">开始游戏</button>

  <!-- 虚拟遥感 -->
  <div id="joystickContainer">
    <div id="joystickBase"></div>
    <div id="joystickThumb"></div>
  </div>

  <!-- 背景音乐 -->
  <audio id="bgm" src="bgm.mp3" loop></audio>
  <!-- 子弹音效 -->
  <audio id="shootSound" src="shoot.mp3"></audio>

  <script>
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");
    const scoreEl = document.getElementById("score");
    const startBtn = document.getElementById("startBtn");

    const bgm = document.getElementById("bgm");
    const shootSound = document.getElementById("shootSound");

    const playerImg = new Image();
    playerImg.src = "player.png";
    const enemyImg = new Image();
    enemyImg.src = "enemy.png";
    const bulletImg = new Image();
    bulletImg.src = "bullet.png";

    const player = { x: canvas.width/2-20, y: canvas.height-80, width: 40, height: 40, speed: 5 };
    let bullets = [], enemies = [], score = 0, gameOver = false;
    const keys = {};

    document.addEventListener("keydown", e => keys[e.code] = true);
    document.addEventListener("keyup", e => keys[e.code] = false);

    function drawPlayer() {
      if (playerImg.complete) ctx.drawImage(playerImg, player.x, player.y, player.width, player.height);
    }
    function shoot() {
      bullets.push({ x: player.x+player.width/2-5, y: player.y, width:10, height:20, speed:7 });
      shootSound.currentTime = 0;
      shootSound.play();
    }
    function drawBullets() {
      bullets.forEach((b,i)=>{ 
        b.y-=b.speed; 
        if(bulletImg.complete) ctx.drawImage(bulletImg,b.x,b.y,b.width,b.height); 
        if(b.y<0) bullets.splice(i,1); 
      });
    }
    function spawnEnemy() { enemies.push({ x: Math.random()*(canvas.width-40), y:-40, width:40, height:40, speed:2+Math.random()*2 }); }
    function drawEnemies() {
      enemies.forEach((e,i)=>{
        e.y+=e.speed; 
        if(enemyImg.complete) ctx.drawImage(enemyImg,e.x,e.y,e.width,e.height);
        if(e.y>canvas.height) enemies.splice(i,1);
        if(isCircleColliding(e.x+e.width/2,e.y+e.height/2,e.width*0.3,player.x+player.width/2,player.y+player.height/2,player.width*0.3)) gameOver=true;
      });
    }
    function checkCollisions() {
      bullets.forEach((b,bi)=>{ enemies.forEach((e,ei)=>{ 
        if(isCircleColliding(b.x+b.width/2,b.y+b.height/2,b.width*0.3,e.x+e.width/2,e.y+e.height/2,e.width*0.3)){
          bullets.splice(bi,1); enemies.splice(ei,1); score+=1; scoreEl.textContent="捉弄次数: "+score;
        }
      });});
    }
    function isCircleColliding(x1,y1,r1,x2,y2,r2){ const dx=x1-x2,dy=y1-y2; return Math.sqrt(dx*dx+dy*dy)<r1+r2; }

    let enemyInterval;
    let isMobile = 'ontouchstart' in window || navigator.maxTouchPoints>0;

    // 摇杆变量
    let joystickX=0, joystickY=0;

    if(isMobile){
      const joystickContainer = document.getElementById("joystickContainer");
      joystickContainer.style.display="block";
      const joystickBase = document.getElementById("joystickBase");
      const joystickThumb = document.getElementById("joystickThumb");
      let moving=false;

      joystickThumb.addEventListener("touchstart", e=>{ e.preventDefault(); moving=true; });
      joystickThumb.addEventListener("touchend", e=>{ e.preventDefault(); moving=false; joystickX=0; joystickY=0; joystickThumb.style.transform="translate(0px,0px)"; });
      joystickThumb.addEventListener("touchmove", e=>{
        e.preventDefault();
        if(!moving) return;
        const touch = e.touches[0];
        const rect = joystickBase.getBoundingClientRect();
        let dx = touch.clientX-(rect.left+rect.width/2);
        let dy = touch.clientY-(rect.top+rect.height/2);
        const distance = Math.sqrt(dx*dx+dy*dy);
        const maxDistance = rect.width/2;
        if(distance>maxDistance){ dx=dx*maxDistance/distance; dy=dy*maxDistance/distance; }
        joystickX = dx/maxDistance;
        joystickY = dy/maxDistance;
        joystickThumb.style.transform=`translate(${dx}px,${dy}px)`;
      });

      // 自动射击
      setInterval(()=>{ if(!gameOver) shoot(); }, 300);
    }

    function updatePlayerMobile(){
      const speed = player.speed;
      player.x += joystickX*speed;
      player.y += joystickY*speed;
      if(player.x<0) player.x=0;
      if(player.x>canvas.width-player.width) player.x=canvas.width-player.width;
      if(player.y<0) player.y=0;
      if(player.y>canvas.height-player.height) player.y=canvas.height-player.height;
    }

    function gameLoop(){
      if(gameOver){
        ctx.fillStyle="white";
        ctx.font="40px Arial";
        ctx.fillText("捉弄失败",canvas.width/2-100,canvas.height/2);
        return;
      }

      ctx.clearRect(0,0,canvas.width,canvas.height);

      if(isMobile) updatePlayerMobile();
      else {
        if(keys["ArrowLeft"] && player.x>0) player.x-=player.speed;
        if(keys["ArrowRight"] && player.x<canvas.width-player.width) player.x+=player.speed;
        if(keys["ArrowUp"] && player.y>0) player.y-=player.speed;
        if(keys["ArrowDown"] && player.y<canvas.height-player.height) player.y+=player.speed;
        if(keys["Space"]){ if(!keys.shooting){ shoot(); keys.shooting=true; } } else { keys.shooting=false; }
      }

      drawPlayer();
      drawBullets();
      drawEnemies();
      checkCollisions();

      requestAnimationFrame(gameLoop);
    }

    startBtn.addEventListener("click", () => {
      startBtn.style.display="none";
      bgm.volume=0.5;
      bgm.play();

      // 确保玩家飞机图片加载完成再开始游戏
      playerImg.onload = () => { enemyInterval = setInterval(spawnEnemy,1000); gameLoop(); };
      if(playerImg.complete){ enemyInterval = setInterval(spawnEnemy,1000); gameLoop(); }
    });
  </script>
</body>
</html>
